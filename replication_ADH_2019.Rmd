---
title: "ADH 2019 Replication"
author: 
- Michael Keller
- Benedikt Marxer
date: "13 4 2022"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true
---
# About ADH 2019

Autor, David, David Dorn, and Gordon Hanson. 2019. "When Work Disappears: Manufacturing Decline and the Falling Marriage Market Value of Young Men." *American Economic Review: Insights*, 1 (2): 161-78. DOI: https://doi.org/10.1257/aeri.20180010

# Setup

Load relevant packages:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
here::i_am("replication_ADH_2019.Rmd")
library(here)
library(tidyverse)
library(haven)
library(bartik.weight)
library(AER)
library(stargazer)
```

```{r setup-visible,  eval=F, echo=T}
here::i_am("replication_ADH_2019.Rmd")
library(here)
library(tidyverse)
library(haven)
library(bartik.weight)
library(AER)
library(stargazer)
```

Load all the data files that are needed for the two replication approaches. The data frames are named following the Bartik package nomenclature.

```{r import-data}
## Main data set
# Source: https://www.ddorn.net/data
temp <- tempfile()
download.file("https://www.ddorn.net/data/ADH-WWD-FileArchive.zip", temp, mode = "wb")
master <- read_dta(unz(temp, "ADH-WWD-AERi-Data/dta/workfile9014wwd.dta"))
unlink(temp)

## ADH China Shock: "Global" Industry-level Growth of Imports (year-industry level)
# Source: https://github.com/paulgp/bartik-weight
ADH_global <- bartik.weight::ADH_global

## ADH China Shock: Local Industry Shares (community-year-industry level)
# Source: https://github.com/paulgp/bartik-weight
ADH_local <- bartik.weight::ADH_local
```


# Old IV Approach

1st stage: $x = a_0 + a_1*B + n$  mit $B=z*g$
2nd stage: $y = b_0 + b_1*x + e$

$x$ = Change in import exposure -> master$d_impusch_p9 (endogen)
$y$ = change manufacturing employment -> master$d_sh_empl_mfg_age1839 (outcome)
$z$ = Chinese export growth -> master$d_impotch_p9_lag (instrument for endogenous x)

Replicates Table 1

Overall trade shock (male+female) 
```{r}
iv_old <- ivreg(d_sh_empl_mfg_age1839 ~ d_impusch_p9 + l_shind_manuf_cbp + l_sh_popedu_c + l_sh_popfborn + l_sh_empl_f + l_sh_routine33 + l_task_outsource + t2 + reg_midatl + reg_encen + reg_wncen + reg_satl + reg_escen + reg_wscen + reg_mount + reg_pacif + l_sh_pop_black + l_sh_pop_asian + l_sh_pop_oth + l_sh_pop_hispanic | d_impotch_p9_lag + l_shind_manuf_cbp + l_sh_popedu_c + l_sh_popfborn + l_sh_empl_f + l_sh_routine33 + l_task_outsource + t2 + reg_midatl + reg_encen + reg_wncen + reg_satl + reg_escen + reg_wscen + reg_mount + reg_pacif + l_sh_pop_black + l_sh_pop_asian + l_sh_pop_oth + l_sh_pop_hispanic, weights = timepwt24, data = master)
summary(iv_old)

stargazer(iv_old, title = "Old Approach", dep.var.labels = "Change in manufacturing employment", covariate.labels = c("Exposure to growing imports"), keep = c("d_impusch_p9", "Constant"), style = "default", type = "text")
```

# New Bartik IV Approach

We keep the structure as in the example provided for the bartik weights package (https://rdrr.io/github/jjchern/bartik.weight/f/README.md)

bw(master, y, x, controls = NULL, weight = NULL, local, Z, global, G)

$master$: The master data frame -> master
$y$: Outcome variable. Change manufacturing employment -> master$d_sh_empl_mfg_age1839 
$x$: Endogenous variable. Change in import exposure -> master$d_impusch_p9
$controls$: Control variables (in master)
$weight$: Weighted variable. Each CZâ€™s share in the start-of-period population -> timepwt24
$local$: The local data frame -> bartik.weight::ADH_local (in wide format!)
$Z$: Local industry shares -> bartik.weight::ADH_local$sh_ind_
$global$: The global data frame -> ADH_global {bartik.weight}
$G$: A string for the the overall industry growth rates -> ADH_global$trade_


```{r}
# Convert industry shares to wide format as suggested by authors in package description.
ADH_local %>%
  mutate(ind = str_glue("t{year}_sh_ind_{ind}")) %>%
  spread(ind, sh_ind_, fill = 0) %>%
  print() -> ADH_local_wide
```

Run estimation

```{r}
# Prepare variables in the master tibble
y <- "d_sh_empl_mfg_age1839" # change manufacturing employment rate
x <- "d_impusch_p9" # Growth imports from China to US
controls <- c("l_shind_manuf_cbp", "l_sh_popedu_c", "l_sh_popfborn", "l_sh_empl_f", "l_sh_routine33", "l_task_outsource", "t2", "reg_midatl", "reg_encen", "reg_wncen", "reg_satl", "reg_escen", "reg_wscen", "reg_mount", "reg_pacif", "l_sh_pop_black", "l_sh_pop_asian", "l_sh_pop_oth", "l_sh_pop_hispanic")
weight <- "timepwt24" # Weighted by population

# Prepare variables in the local tibble
# This function operates row-wise on dataframes, and element-wise among the outcomes of ps objects. The elements of setdiff(x,y) are those elements in x but not in y. The definition is taken to match the version in the base package.
Z <- setdiff(names(ADH_local_wide), c("czone", "year")) # Funktion, damit Z nur Industry share von 2000

# Prepare variables in the global tibble
G <- "trade_" # Globale Wachstumsrate: Growth imports from China to other rich countries

# Estimate the weight (alpha) and the IV estimates (beta)
bw <- bw(master, y, x, controls, weight, ADH_local_wide, Z, ADH_global, G) 
bw 

```

```{r}
# Table A1 (GPSS OA)

# Panel A: Negative and positive weights
sum(bw$alpha[bw$alpha<0])
mean(bw$alpha[bw$alpha<0])
sum(bw$alpha<0)/nrow(bw)

sum(bw$alpha[bw$alpha>0])
mean(bw$alpha[bw$alpha>0])
sum(bw$alpha>0)/nrow(bw)


# Top five Rotemberg weight industries
bw %>%
  top_n(5, alpha) %>%
  arrange(desc(alpha)) %>%
  mutate(ind = case_when(
    ind == "3571" ~ "Electronic Computers",
    ind == "3663" ~ "Radio and Television Broadcasting and Communications Equipment",
    ind == "3674" ~ "Semiconductors and Related Devices",
    ind == "3661" ~ "Telephone Apparatus",
    ind == "3679" ~ "Electronic Components, Not Elsewhere Classified"
  )) %>%
  rename(g = trade_) %>%
  knitr::kable(digits = 3, caption = "Top five Rotemberg weight industries")


# Open task: Construct a similar table as Table A1 in the GPSS OA (Summary of the Rotemberg weights: China shock)

bw2 <- bw %>% mutate(c = alpha * beta)
sum(bw2$c) # is this our estiamte?
```


sessionInfo {utils}: Collect Information About the Current R Session
```{r sessionInfo}
sessioninfo::session_info()
```

