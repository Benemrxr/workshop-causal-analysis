---
title: "ADH 2019 Replication"
author: 
- Michael Keller
- Benedikt Marxer
date: "13 4 2022"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true
---
# About ADH 2019

Autor, David, David Dorn, and Gordon Hanson. 2019. "When Work Disappears: Manufacturing Decline and the Falling Marriage Market Value of Young Men." *American Economic Review: Insights*, 1 (2): 161-78. DOI: https://doi.org/10.1257/aeri.20180010

# Setup

Load relevant packages:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
here::i_am("replication_ADH_2019.Rmd")
library(here)
library(tidyverse)
library(haven)
library(bartik.weight)
library(AER)
library(stargazer)
```

```{r setup-visible,  eval=F, echo=T}
here::i_am("replication_ADH_2019.Rmd")
library(here)
library(tidyverse)
library(haven)
library(bartik.weight)
library(AER)
library(stargazer)
```

Load all the data files that are needed for the two replication approaches. The data frames are named following the Bartik package nomenclature.

```{r import-data}
## Main data set
# Source: https://www.ddorn.net/data
# Note: Can we also use the bartik.weight::ADH_master data?
temp <- tempfile()
download.file("https://www.ddorn.net/data/ADH-WWD-FileArchive.zip", temp, mode = "wb")
master <- read_dta(unz(temp, "ADH-WWD-AERi-Data/dta/workfile9014wwd.dta"))
unlink(temp)

## Imports from China by sic87dd industry in US and other wealthy countries, 1991-2014.
# Source: https://www.ddorn.net/data
temp <- tempfile()
download.file("https://www.ddorn.net/data/sic87dd_exposure_9114.zip", temp, mode = "wb")
exposure <- read_dta(unz(temp, "sic87dd_exposure_9114.dta"))
unlink(temp)

# (unused)
## Trade flows by sic87dd industry, importer, exporter, and year 1991-2014.
# Source: https://www.ddorn.net/data
temp <- tempfile()
download.file("http://www.ddorn.net/data/china9114.zip", temp, mode = "wb")
trade_flows <- read_dta(unz(temp, "china9114.dta"))
unlink(temp)

# (unused)
## Provides employment counts by county by industry. The employment numbers are often reported only in brackets.
# Source: https://www.ddorn.net/data
temp <- tempfile()
download.file("https://www.ddorn.net/data/AADHP-GreatSag-FileArchive.zip", temp, mode = "wb")
ind_shares_data <- read_dta(unz(temp, "AADHP-JOLE-Sag-Replication-2015-05-13/dta/cbp/county/clean/emp_counts/cbp_czone_merged.dta"))
unlink(temp)

## Local industry share at the community-year-industry level.
# Source: https://github.com/paulgp/bartik-weight
ind_shares_package <- bartik.weight::ADH_local
```


# Old IV Approach


1st stage: $x = a_0 + a_1*B + n$  mit $B=z*g$
2nd stage: $y = b_0 + b_1*x + e$


$x$ = Change in import exposure -> master$d_impusch_p9 (endogen)
$y$ = change manufacturing employment -> master$d_sh_empl_mfg_age1839 (outcome)
$z$ = Chinese export growth -> master$d_impotch_p9_lag (instrument for endogenous x)


Replicates Table 1

overall trade shock (male+female) 
```{r}
iv_old <- ivreg(d_sh_empl_mfg_age1839 ~ d_impusch_p9 +
  l_shind_manuf_cbp + l_sh_popedu_c + l_sh_popfborn +
  l_sh_empl_f + l_sh_routine33 + l_task_outsource + t2 +
  reg_midatl + reg_encen + reg_wncen + reg_satl + reg_escen +
  reg_wscen + reg_mount + reg_pacif + l_sh_pop_black + l_sh_pop_asian +
  l_sh_pop_oth + l_sh_pop_hispanic |
  d_impotch_p9_lag +
    l_shind_manuf_cbp + l_sh_popedu_c + l_sh_popfborn +
    l_sh_empl_f + l_sh_routine33 + l_task_outsource + t2 +
    reg_midatl + reg_encen + reg_wncen + reg_satl + reg_escen +
    reg_wscen + reg_mount + reg_pacif + l_sh_pop_black + l_sh_pop_asian +
    l_sh_pop_oth + l_sh_pop_hispanic, weights = timepwt24, data = master)
summary(iv_old)


stargazer(iv_old, title = "Old Approach", dep.var.labels = "Change in manufacturing employment", covariate.labels = c("Exposure to growing imports"), keep = c("d_impusch_p9", "Constant"), style = "default", type = "text")
```




# New Bartik IV Approach

We keep the structure as in the example provided for the bartik weights package (https://rdrr.io/github/jjchern/bartik.weight/f/README.md)

$x$ = Change in import exposure -> master$d_impusch_p9
$y$ = change manufacturing employment -> master$d_sh_empl_mfg_age1839  
$z$ = industry shares -> ind_shares_package
$g$ = Chinese export growth -> workfile9014wwd$d_impotch_p9_lag


## Step 1: Construct difference in import penetration variables. Equation 1 in paper

Import penetration $\Delta IP_jt^cu = \Delta M_{jt}^{cu}/(Y_{j91} + M_{j91} - X_{j91})$


$x$ and $y$ are the same variables as in the old approach. The import exposure is provided as one single variable by the authors (the $z$: d_impotch_p9_lag). In order to use the bartik.weight R package we need two seperate inputs: The shares $z$ and the shifts $g$

$z$ is the industry share
$g$ the measure for import penetration


This approach uses as $z$ the weights provided by the bartik.weight package because the authors do not provide them in their data set.



```{r}
# Convert industry shares to wide format as suggested by authors in package description. One could also use the file provided in wide format but this step would allow to transform any file which would probably be supplied in long format.

ind_shares_package %>%
  mutate(ind = str_glue("t{year}_sh_ind_{ind}")) %>%
  spread(ind, sh_ind_, fill = 0) %>%
  print() -> ind_shares_package_wide
```


This is to construct the import penetration measure (the G)

```{r}
# New DataFrame
penetration_j <- exposure # from https://www.ddorn.net/data/sic87dd_exposure_9114.zip

# pen_91, pen_00, pen_14: Import absorption. Calculated as in equation 3. Imports of each industry j divided by domestic market size plus net imports of that industry.
penetration_j$pen_91 <- penetration_j$l_import_otch_1991 / (penetration_j$market1991 + penetration_j$l_import_otch_1991)
penetration_j$pen_00 <- penetration_j$l_import_otch_2000 / (penetration_j$market1991 + penetration_j$l_import_otch_1991)
penetration_j$pen_14 <- penetration_j$l_import_otch_2014 / (penetration_j$market1991 + penetration_j$l_import_otch_1991)

# Keep only relevant columns to reduce size of DataFrame
penetration_j <- penetration_j[c("sic87dd", "pen_91", "pen_00", "pen_14")]

# Remane industry code
names(penetration_j)[1] <- "industry_code"

# d_xx_xx: Difference of import penetration within period
penetration_j$d_00_91 <- penetration_j$pen_00 - penetration_j$pen_91 # Difference in import penetration 1991-2000
penetration_j$d_14_00 <- penetration_j$pen_14 - penetration_j$pen_00 # Difference in import penetration 2000-2014
penetration_j$d_14_91 <- penetration_j$pen_14 - penetration_j$pen_91 # Difference in import penetration 1991-2014

# Construct global DataFrame
global <- data.frame(
  ind <- c(rep(penetration_j$industry_code, 2)),
  year <- c(rep(1990, 397), rep(2000, 397)),
  penetration <- c(penetration_j$d_00_91, penetration_j$d_14_00)
)


# Remane columns
names(global)[1] <- "ind"
names(global)[2] <- "year"
names(global)[3] <- "penetration"
```


Here we ran into a problem: The global DataFrame contains 397 industries in each year (794 in total). The bartik.package data for 1990 contains only 390 industries per year
```{r}
# 397 industry codes in global
length(unique(global$ind))

# 390 industry codes in ADH_local
length(unique(ADH_local$ind))


# Subset global such that it contains only industries that are also in the bartik.package. Save in new DataFrame global_2

# 1) unique industry codes in bartik.package
ind_adh <- unique(ADH_local$ind)

# 2) Subset global accordingly and save in new DataFrame
global_2 <- subset(global, ind %in% ind_adh)
```

Run estimation

```{r}
# Prepare variables in the master tibble
y <- "d_sh_empl_mfg_age1839" # change manufacturing employment rate
x <- "d_impusch_p9" # Growth imports from China to US

controls <- c("l_shind_manuf_cbp", "l_sh_popedu_c", "l_sh_popfborn", "l_sh_empl_f", "l_sh_routine33", "l_task_outsource", "t2", "reg_midatl", "reg_encen", "reg_wncen", "reg_satl", "reg_escen", "reg_wscen", "reg_mount", "reg_pacif", "l_sh_pop_black", "l_sh_pop_asian", "l_sh_pop_oth", "l_sh_pop_hispanic")

weight <- "timepwt24" # Weighted by population

# Prepare variables in the local tibble
# This function operates row-wise on dataframes, and element-wise among the outcomes of ps objects. The elements of setdiff(x,y) are those elements in x but not in y. The definition is taken to match the version in the base package.
Z <- setdiff(names(ADH_local_wide), c("czone", "year")) # Funktion, damit Z nur Industry share von 2000

# Prepare variables in the global tibble
G <- "penetration" # Globale Wachstumsrate: Growth imports from China to other rich countries

# Estimate the weight (alpha) and the IV estimates (beta)
bw <- bw(master, y, x, controls, weight, ind_shares_package_wide, Z, global_2, G) # Master: Master Datensatz
bw # y outcome variable
# x endogene Variable
# controls Kontrollvariable
# weight gewichtete Variable, unklar
# ADH_local2 Datensatz local industry share
# Z Name Indusry share variablen in ADH_local2
# ADH_global Datensatz globale Wachstumsrate
# G Globale Wachstumsrate



max(bw$alpha)

bw %>%
  top_n(5, alpha) %>%
  arrange(desc(alpha)) %>%
  mutate(ind = case_when(
    ind == "3571" ~ "Electronic Computers",
    ind == "3944" ~ "Games and Toys",
    ind == "3651" ~ "Household Audio and Video",
    ind == "3661" ~ "Telephone Apparatus",
    ind == "3577" ~ "Computer Equipment",
    ind == "3663" ~ "Radio and Television Broadcasting and Communications Equipment",
    ind == "3674" ~ "Semiconductors and Related Devices",
    ind == "3144" ~ "Women's Footwear, Except Athletic"
  )) %>%
  rename(g = penetration)

# Open question: Why do we estimate the effect for both time-periods?

# Open task: Construct a similar table as Table A1 in the GPSS OA (Summary of the Rotemberg weights: China shock)

sum(bw$alpha * bw$beta)

df <- subset(bw)
```


sessionInfo {utils}: Collect Information About the Current R Session
```{r sessionInfo}
sessioninfo::session_info()
```

